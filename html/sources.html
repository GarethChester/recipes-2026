<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue 3 + BigQuery Sandbox</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div id="app">
    <li v-for="(row, index) in results" :key="index">
          {{ row.f[0].v }}
        </li>

  </div>
<script>
  const { createApp, ref, onMounted } = Vue;

    createApp({
        setup() {
            // CONFIGURATION
            const CLIENT_ID = '872552222655-gu78ic30706c6164v8st2hu67vj36vhn.apps.googleusercontent.com';
            const PROJECT_ID = 'recipes-46d2e';
            
            // STATE
            const isLoggedIn = ref(false);
            const loading = ref(false);
            const errorMessage = ref(null);
            const results = ref([]);
            const schema = ref([]);
            let tokenClient;

            // 1. Initialize Google Auth on Mount
            onMounted(() => {
                if (window.google) {
                    initializeGsi();
                } else {
                    // Fallback if script loads after component
                    window.onload = initializeGsi;
                }
            });

            const initializeGsi = () => {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/bigquery.readonly',
                    callback: (response) => {
                        if (response.access_token) {
                            sessionStorage.setItem('bq_access_token', response.access_token);
                            isLoggedIn.value = true;
                            errorMessage.value = null;
                            runBigQuery(response.access_token);
                        }
                    },
                });

                // Auto-login check
                const cachedToken = sessionStorage.getItem('bq_access_token');
                if (cachedToken) {
                    isLoggedIn.value = true;
                    runBigQuery(cachedToken);
                }
            };

            // 2. Auth Actions
            const handleAuthClick = () => {
                tokenClient.requestAccessToken({prompt: 'none'});
            };

            const logout = () => {
                sessionStorage.removeItem('bq_access_token');
                isLoggedIn.value = false;
                results.value = [];
            };

            // 3. The BigQuery API Call
            const runBigQuery = async (token) => {
                loading.value = true;
                errorMessage.value = null;

                const queryRequest = {
                    query: "SELECT source_id, source_name FROM `recipes-46d2e.recipes.sources`",
                    useLegacySql: false
                };

                try {
                    const response = await fetch(`https://bigquery.googleapis.com/bigquery/v2/projects/${PROJECT_ID}/queries`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(queryRequest)
                    });

                    const data = await response.json();

                    if (data.error) {
                        if (data.error.code === 401) {
                            logout(); // Token expired
                        } else {
                            throw new Error(data.error.message);
                        }
                    } else {
                      console.log(results)
                        results.value = data.rows || [];
                        schema.value = data.schema.fields || [];
                    }
                } catch (err) {
                    errorMessage.value = "BigQuery Error: " + err.message;
                } finally {
                    loading.value = false;
                }
            };

            return {
                isLoggedIn, loading, results, schema, errorMessage,
                handleAuthClick, logout
            };
        }
    }).mount('#app');

  </script>

 
</body>



<script setup>
import { onMounted, ref } from 'vue';

const results = ref([]);
const isLoggedIn = ref(false);
let tokenClient;

const CLIENT_ID = '872552222655-gu78ic30706c6164v8st2hu67vj36vhn.apps.googleusercontent.com';
const PROJECT_ID = 'recipes-46d2e';

onMounted(() => {
  // 1. Initialize the Google Token Client
  if (window.google) {
    tokenClient = window.google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/bigquery',
      callback: (response) => {
        if (response.access_token) {
          sessionStorage.setItem('google_access_token', response.access_token);
          isLoggedIn.value = true;
          runQuery(response.access_token);
        }
      },
    });

    // 2. Check for an existing session token immediately
    const cachedToken = sessionStorage.getItem('google_access_token');
    if (cachedToken) {
      isLoggedIn.value = true;
      runQuery(cachedToken);
    }
  }
});

// 3. The trigger for the popup
const handleAuthClick = () => {
  tokenClient.requestAccessToken({prompt:"none"});
};

async function runQuery(token) {
  try {
    const res = await fetch(`https://bigquery.googleapis.com/bigquery/v2/projects/${PROJECT_ID}/queries`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        query: "SELECT source_id, source_name from `recipes-46d2e.recipes.sources`",
        useLegacySql: false
      })
    });
    
    const data = await res.json();
    if (data.rows) {
      results.value = data.rows;
    } else if (data.error && data.error.code === 401) {
      // Token expired! Wipe it and update UI
      sessionStorage.removeItem('google_access_token');
      isLoggedIn.value = false;
    }
  } catch (err) {
    console.error("Query failed", err);
  }
}
</script>

<template>
  <div>
    <h1>BigQuery Explorer</h1>
    
    <button v-if="!isLoggedIn" @click="handleAuthClick">
      Login with Google
    </button>
    
    <div v-else>
      <p>Logged In âœ…</p>
      <ul>
        <li v-for="(row, index) in results" :key="index">
          {{ row.f[0].v }}
        </li>
      </ul>
    </div>
  </div>
</template>